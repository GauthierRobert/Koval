<div class="history-container">
  <!-- Tag folders from coach -->
  <div class="tag-folders" *ngIf="folderNames.length">
    <!-- Collapsed view -->
    <ng-container *ngIf="!expandedFolder">
      <h3 class="section-title">Coach Trainings</h3>
      <div class="folder-list">
        <div *ngFor="let name of folderNames" class="folder-item" (click)="expandFolder(name)">
          <span class="folder-icon">&#128193;</span>
          <span class="folder-name">{{ name }}</span>
          <span class="folder-count">{{ folders[name]?.length || 0 }}</span>
        </div>
      </div>
    </ng-container>
    <!-- Expanded view -->
    <ng-container *ngIf="expandedFolder">
      <div class="folder-back-row">
        <button class="folder-back-btn" (click)="collapseFolder()">&larr;</button>
        <h3 class="section-title" style="margin-bottom: 0">{{ expandedFolder }}</h3>
      </div>
      <div class="folder-trainings" *ngIf="folders[expandedFolder]?.length">
        <div *ngFor="let t of folders[expandedFolder]" class="history-item"
          [class.active]="(selectedTraining$ | async)?.id === t.id" (click)="onSelectFolderTraining(t)">
          <div class="item-icon">&#128193;</div>
          <div class="item-details">
            <div class="item-title-row">
              <span class="item-title">{{ t.title }}</span>
              <span *ngIf="t.trainingType" class="type-badge" [style.background]="getTypeColor(t.trainingType) + '20'"
                [style.color]="getTypeColor(t.trainingType)"
                [style.border-color]="getTypeColor(t.trainingType) + '40'">{{ getTypeLabel(t.trainingType) }}</span>
            </div>
            <span class="item-meta"><span [style.font-style]="isDurationEstimated(t) ? 'italic' : ''">{{ getDuration(t) }}</span> &bull; {{ (t.blocks || []).length }} blocks</span>
          </div>
        </div>
      </div>
      <div class="folder-empty" *ngIf="!folders[expandedFolder]?.length">
        No trainings shared yet
      </div>
    </ng-container>
  </div>

  <h3 class="section-title">Your Workouts</h3>

  <!-- Tag filter: My Workouts + one pill per tag -->
  <div class="type-filters">
    <span class="type-pill"
      [class.active]="(activeTagFilter$ | async) === '__mine__'"
      (click)="setTagFilter('__mine__')">My Workouts</span>
    <ng-container *ngIf="availableTags$ | async as tags">
      <span *ngFor="let tag of tags" class="type-pill"
        [class.active]="(activeTagFilter$ | async) === tag"
        (click)="setTagFilter(tag)">{{ tag }}</span>
    </ng-container>
  </div>

  <!-- Sport filter -->
  <div class="type-filters">
    <span *ngFor="let s of sportOptions" class="type-pill"
      [class.active]="(activeSportFilter$ | async) === s.value"
      (click)="setSportFilter(s.value)">{{ s.label }}</span>
  </div>

  <!-- Training type filter -->
  <div class="type-filters">
    <span *ngFor="let type of trainingTypes" class="type-pill"
      [class.active]="(activeTypeFilter$ | async) === type"
      [style.--pill-color]="getTypeColor(type)"
      (click)="setTypeFilter(type)">{{ getTypeLabel(type) }}</span>
  </div>

  <div class="history-list">
    <div *ngFor="let training of filteredTrainings$ | async" class="history-item"
      [class.active]="(selectedTraining$ | async)?.id === training.id" (click)="onSelect(training)">
      <div class="item-icon">
        <app-sport-icon [sport]="training.sportType" [size]="20"></app-sport-icon>
      </div>
      <div class="item-details">
        <div class="item-title-row">
          <span class="item-title">{{ training.title }}</span>
          <span *ngIf="training.trainingType" class="type-badge"
            [style.background]="getTypeColor(training.trainingType) + '20'"
            [style.color]="getTypeColor(training.trainingType)"
            [style.border-color]="getTypeColor(training.trainingType) + '40'">{{ getTypeLabel(training.trainingType) }}</span>
        </div>
        <span class="item-meta"><span [style.font-style]="isDurationEstimated(training) ? 'italic' : ''">{{ getDuration(training) }}</span> &bull; {{ (training.blocks || []).length }} blocks</span>
        <div class="item-tags" *ngIf="training.tags?.length">
          <span *ngFor="let tag of training.tags" class="tag-chip">{{ tag }}</span>
        </div>
      </div>
      <button class="delete-btn" title="Delete training" (click)="onDelete($event, training)">&times;</button>
    </div>
  </div>
</div>
