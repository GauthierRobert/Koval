<div class="calendar-layout">
  <div class="header">
    <h1>Training <span class="highlight">Calendar</span></h1>
    <div class="header-right">
      <!-- Overdue workouts inline with header -->
      <div class="overdue-strip" *ngIf="overdueWorkouts$ | async as overdue">
        <ng-container *ngIf="overdue.length > 0">
          <span class="overdue-label">OVERDUE</span>
          <span *ngFor="let w of overdue" class="overdue-chip" (click)="selectWorkout(w)">
            <app-sport-icon [sport]="w.sportType" [size]="12"></app-sport-icon>
            {{ w.trainingTitle || w.title || 'Workout' }}
          </span>
        </ng-container>
      </div>
      <div class="view-selector">
        <button [class.active]="viewMode === 'week'" (click)="setViewMode('week')">Week</button>
        <button [class.active]="viewMode === 'month'" (click)="setViewMode('month')">Month</button>
      </div>
      <div class="nav-controls">
        <button (click)="navigateWeek(-1)">&lt; {{ viewMode === 'week' ? 'Prev' : 'Last Month' }}</button>
        <span class="date-range" *ngIf="viewMode === 'week'">{{ startDate | date : 'MMM d' }} - {{ endDate | date : 'MMM d, y' }}</span>
        <span class="date-range" *ngIf="viewMode === 'month'">{{ startDate | date : 'MMMM yyyy' }}</span>
        <button (click)="navigateWeek(1)">{{ viewMode === 'week' ? 'Next' : 'Next Month' }} &gt;</button>
      </div>
    </div>
  </div>

  <ng-container *ngIf="workoutsByDay$ | async as wbd">
    <div class="calendar-grid" *ngIf="viewMode === 'week'">
      <!-- ... existing week grid content ... -->
      <div *ngFor="let day of weekDays; trackBy: trackByDay" class="day-column glass" [class.today]="day.isToday">
        <!-- Week Day Column Content - KEEP EXISTING -->
        <div class="day-header">
          <span class="weekday">{{ day.date | date : 'EEE' }}</span>
          <span class="day-number">{{ day.date | date : 'd' }}</span>
        </div>

        <div class="workout-slot" cdkDropList [cdkDropListData]="wbd.get(day.key) || EMPTY"
          (cdkDropListDropped)="onDrop($event, day)">
          <div *ngFor="let workout of wbd.get(day.key) || EMPTY; trackBy: trackByWorkout" class="workout-card clickable"
            cdkDrag [cdkDragData]="workout" [class.completed]="workout.status === 'COMPLETED'"
            [class.skipped]="workout.status === 'SKIPPED'"
            [style.border-left]="'3px solid ' + (workout.trainingType ? getTypeColor(workout.trainingType) : 'var(--accent-color)')"
            (click)="selectWorkout(workout)">
            <div class="card-top">
              <span class="workout-time">08:00 AM</span>
              <div class="card-top-right">
                <span class="status-badge" *ngIf="workout.status !== 'PENDING'">{{
                  workout.status
                  }}</span>
                <button class="delete-btn" (click)="deleteWorkout(workout); $event.stopPropagation()" title="Remove">
                  &times;
                </button>
              </div>
            </div>

            <div class="workout-info">
              <div class="title-row">
                <app-sport-icon [sport]="workout.sportType" [size]="18"></app-sport-icon>
                <span class="workout-title">
                  {{ workout.trainingTitle || workout.title || 'Session #' + workout.trainingId.substring(0, 6) }}
                </span>
              </div>
              <span *ngIf="workout.trainingType" class="type-badge"
                [style.background]="getTypeColor(workout.trainingType) + '20'"
                [style.color]="getTypeColor(workout.trainingType)"
                [style.border-color]="getTypeColor(workout.trainingType) + '40'">{{ getTypeLabel(workout.trainingType)
                }}</span>

              <div class="technical-metrics">
                <div class="m-item">
                  <span class="m-val">{{ formatDuration(workout) }}</span>
                  <span class="m-unit">DUR</span>
                </div>
                <div class="m-item">
                  <span class="m-val">{{ workout.tss || '-' }}</span>
                  <span class="m-unit">TSS</span>
                </div>
                <div class="m-item">
                  <span class="m-val">{{ workout.intensityFactor || workout.if || '-' }}</span>
                  <span class="m-unit">IF</span>
                </div>
              </div>
            </div>

            <div class="workout-actions" *ngIf="workout.status === 'PENDING'">
              <button class="btn-complete" [disabled]="isFutureDate(workout.scheduledDate)"
                (click)="markComplete(workout); $event.stopPropagation()">COMPLETE</button>
              <button class="btn-skip" (click)="markSkipped(workout); $event.stopPropagation()">SKIP</button>
            </div>
          </div>

          <button class="add-btn" (click)="openScheduleModal(day)">+ ADD</button>

          <div *ngIf="!(wbd.get(day.key) || EMPTY).length" class="rest-day">REST DAY</div>
        </div>
      </div>
    </div>

    <app-training-load-chart *ngIf="viewMode === 'week'" [workoutsByDay]="wbd"
      [days]="weekDays"></app-training-load-chart>

    <div class="month-grid" *ngIf="viewMode === 'month'">
      <div class="month-day-names">
        <span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span><span>SUN</span>
      </div>
      <div class="month-body">
        <div *ngFor="let day of monthDays; trackBy: trackByDay" class="month-cell glass" [class.today]="day.isToday"
          [class.other-month]="day.date.getMonth() !== startDate.getMonth()">
          <div class="cell-header">
            <span class="cell-day">{{ day.date | date : 'd' }}</span>
            <button class="cell-add" (click)="openScheduleModal(day)">+</button>
          </div>
          <div class="cell-workouts" cdkDropList [cdkDropListData]="wbd.get(day.key) || EMPTY"
            (cdkDropListDropped)="onDrop($event, day)">
            <div *ngFor="let workout of wbd.get(day.key) || EMPTY; trackBy: trackByWorkout" class="mini-card" cdkDrag
              [cdkDragData]="workout" (click)="selectWorkout(workout)"
              [style.border-left]="'2px solid ' + (workout.trainingType ? getTypeColor(workout.trainingType) : 'var(--accent-color)')">
              <app-sport-icon [sport]="workout.sportType" [size]="10"></app-sport-icon>
              <span class="mini-title">{{ workout.trainingTitle || workout.title || 'Workout' }}</span>
              <span class="mini-tss">{{ workout.tss || 0 }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<app-schedule-modal [isOpen]="isScheduleModalOpen" [preselectedDate]="selectedDate" mode="athlete"
  (closed)="isScheduleModalOpen = false" (scheduled)="onScheduled()"></app-schedule-modal>

<app-workout-detail-modal [workout]="selectedWorkout" (closed)="onDetailClosed()" (started)="onDetailStarted()"
  (statusChanged)="onDetailStatusChanged()"></app-workout-detail-modal>
