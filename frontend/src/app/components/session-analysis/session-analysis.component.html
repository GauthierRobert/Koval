<ng-container *ngIf="session$ | async as session">
  <ng-container *ngIf="ftp$ | async as ftp">
    <div class="analysis-page">

      <!-- Header with inline key metrics -->
      <div class="page-header glass">
        <div class="header-info">
          <div class="header-sport">
            <app-sport-icon [sport]="session.sportType" [size]="20"></app-sport-icon>
          </div>
          <div class="header-title-block">
            <div class="title-row-compact">
              <h1 class="session-title">{{ session.title }}</h1>
              <div class="inline-metrics secondary">
                <span class="inline-metric highlight">{{ getTss(session, ftp) }} <small>TSS</small></span>
                <span class="inline-metric">{{ getIF(session, ftp) | number:'1.1-1' }} <small>IF</small></span>
                <span class="inline-metric">{{ formatTime(session.totalDuration) }} <small>DUR</small></span>
              </div>
            </div>
            <span class="session-date">{{ formatDate(session.date) }}</span>
          </div>
        </div>
        <div class="rpe-input-block" *ngIf="!session.tss && !session.rpe">
          <span class="rpe-label">RATE EFFORT (1-10):</span>
          <input type="number" min="1" max="10" (change)="saveRpe(session, $event)" placeholder="—" class="rpe-input">
        </div>
        <div class="rpe-display" *ngIf="!session.tss && session.rpe">
          <span class="rpe-label">RPE:</span>
          <span class="rpe-val">{{ session.rpe }}</span>
        </div>
      </div>

      <!-- Secondary stat cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-label">Avg Power</span>
          <span class="stat-value">{{ session.avgPower }}<span class="stat-unit">W</span></span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Avg HR</span>
          <span class="stat-value">{{ session.avgHR }}<span class="stat-unit">bpm</span></span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Avg Cadence</span>
          <span class="stat-value">{{ session.avgCadence }}<span class="stat-unit">rpm</span></span>
        </div>
      </div>

      <!-- FIT timeseries chart -->
      <div class="chart-section glass">
        <div class="section-label">FIT TIME-SERIES</div>
        <ng-container *ngIf="fitState$ | async as fit">
          <app-fit-timeseries-chart *ngIf="!fit.loading && !fit.error && fit.records.length > 0" [records]="fit.records"
            [ftp]="ftp" [sportType]="session.sportType">
          </app-fit-timeseries-chart>
          <div class="no-fit-msg" *ngIf="!fit.loading && !fit.error && fit.records.length === 0">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
              opacity="0.4">
              <path d="M3 3l18 18M10.5 10.677A2 2 0 0 0 10 12a2 2 0 0 0 4 0 2 2 0 0 0-.5-1.323" />
              <path d="M3 10l3 2 2-4 2 7 2-5 2 2h5" />
            </svg>
            <p>No FIT data stored for this session</p>
            <p class="hint">Start a live session to auto-record time-series data, or import a .FIT file</p>
          </div>
          <div class="no-fit-msg" *ngIf="fit.loading">
            <div class="loading-dots"><span></span><span></span><span></span></div>
            <p>Loading FIT data...</p>
          </div>
          <div class="no-fit-msg error" *ngIf="fit.error">
            Could not load or parse the FIT file.
          </div>
        </ng-container>
      </div>

      <!-- Block breakdown -->
      <div class="blocks-section glass" *ngIf="session.blockSummaries.length">
        <div class="section-label">BLOCK BREAKDOWN</div>
        <div class="blocks-table">
          <div class="blocks-header">
            <span>Block</span>
            <span>Type</span>
            <span>Duration</span>
            <span>Target</span>
            <span>Actual Pwr</span>
            <span>HR</span>
            <span>Cad</span>
          </div>
          <div *ngFor="let block of session.blockSummaries" class="blocks-row">
            <span class="b-label">{{ block.label }}</span>
            <span class="b-type">{{ block.type }}</span>
            <span class="b-dur">{{ formatTime(block.durationSeconds) }}</span>
            <span class="b-target">{{ block.targetPower ? (block.targetPower + 'W') : '—' }}</span>
            <span class="b-actual" [class.above]="block.actualPower > block.targetPower * 1.05"
              [class.below]="block.targetPower > 0 && block.actualPower < block.targetPower * 0.95">
              {{ block.actualPower | number:'1.0-0' }}W
            </span>
            <span class="b-hr">{{ block.actualHR | number:'1.0-0' }}</span>
            <span class="b-cad">{{ block.actualCadence | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>

    </div>
  </ng-container>
</ng-container>