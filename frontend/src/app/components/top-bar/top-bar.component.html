<header class="top-bar glass">
  <div class="brand" routerLink="/dashboard" style="cursor: pointer">
    <div class="logo">
      <div class="logo-inner"></div>
    </div>
    <span class="app-title">Koval <span class="accent">TRAINING</span></span>
  </div>

  <nav class="nav-links">
    <a routerLink="/dashboard" routerLinkActive="active" class="nav-link">DASHBOARD</a>
    <a routerLink="/chat" routerLinkActive="active" class="nav-link">ASSISTANT</a>
    <a routerLink="/calendar" routerLinkActive="active" class="nav-link">CALENDAR</a>
    <a routerLink="/coach" routerLinkActive="active" class="nav-link" *ngIf="isCoach$ | async">COACHING</a>
  </nav>

  <div class="right-section">
    <div class="topbar-controls">
      <button class="device-btn" (click)="toggleSettings()" title="Reference Values">
        <svg class="bt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3" />
          <path
            d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z" />
        </svg>
      </button>

      <button class="device-btn" (click)="toggleDevices()" title="Manage Devices">
        <svg class="bt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M6.5 6.5l11 11L12 23V1l5.5 5.5-11 11" />
        </svg>
        <span class="device-badge" *ngIf="(connectedCount$ | async)! > 0">{{ connectedCount$ | async }}</span>
      </button>
    </div>

    <div class="action-wrapper">
      <button class="action-btn" (click)="togglePopup($event)">
        NEW TRAINING
      </button>

      <!-- Quick Chat Popup -->
      <div class="quick-chat-popup glass" *ngIf="isPopupOpen" (click)="$event.stopPropagation()">
        <div class="popup-header">
          <h4>Generate Training</h4>
          <button class="close-btn" (click)="closePopup()">Ã—</button>
        </div>
        <p class="popup-intro">Describe your goal to the Assistant:</p>
        <textarea [(ngModel)]="requestDescription" placeholder="e.g., I want an FTP booster session with over-unders..."
          (keydown.enter)="$event.preventDefault(); submitRequest()" autofocus></textarea>
        <div class="popup-footer">
          <button class="submit-btn" [disabled]="!requestDescription.trim()" (click)="submitRequest()">
            GENERATE TRAINING
          </button>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Overlay to close popup when clicking outside -->
<div class="popup-overlay" *ngIf="isPopupOpen" (click)="closePopup()"></div>